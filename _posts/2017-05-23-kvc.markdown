---
layout: post
title:  KVCã€KVOçš„ä½¿ç”¨åŠåŸç†
date:   2017-05-23 19:40:32
author:  "Yvan"
header-img: "img/post-bg-03.jpg"
---
KVCæ˜¯ä»€ä¹ˆï¼Ÿ

## å…³äºKVC

### KVCæ˜¯ä»€ä¹ˆï¼Ÿ

Key-Value Codingï¼Œå³é”®å€¼ç¼–ç ã€‚å®ƒæ˜¯ä¸€ç§ä¸é€šè¿‡å­˜å–æ–¹æ³•ï¼Œè€Œé€šè¿‡å±æ€§åç§°å­—ç¬¦ä¸²é—´æ¥è®¿é—®å±æ€§çš„æœºåˆ¶ã€‚

### KVCå¸¸ç”¨çš„æ–¹æ³•

å‰ä¸¤ä¸ªæ–¹æ³•æ— è®ºè·å–å€¼è¿˜æ˜¯èµ‹å€¼ï¼Œåªéœ€è¦ä¼ å…¥å±æ€§åç§°çš„å­—ç¬¦ä¸²å°±è¡Œäº†ã€‚ä½†KVCä¹Ÿæä¾›äº†ä¼ å…¥pathçš„æ–¹æ³•ã€‚æ‰€è°“'path'ï¼Œå°±æ˜¯ç”¨ç‚¹å·è¿æ¥çš„å¤šå±‚çº§çš„å±æ€§ï¼Œæ¯”å¦‚`student.name`ï¼Œ`student`å±æ€§é‡Œçš„`name`å±æ€§ã€‚
```
- (id)valueForKey:(NSString *)key;
- (void)setValue:(id)value forKey:(NSString *)key;

- (id)valueForKeyPath:(NSString *)keyPath;
- (void)setValue:(id)value forKeyPath:(NSString *)keyPath;
```

### KVCå¯¹å¤šç§æ•°æ®ç±»å‹çš„æ”¯æŒ
é¦–å…ˆè¦è¯´çš„æ˜¯å¯¹äºåŸºæœ¬æ•°æ®ç±»å‹çš„å±æ€§ï¼ŒKVCçš„è¿™å‡ ä¸ªæ–¹æ³•ä¼šè‡ªåŠ¨è£…ç®±å’Œæ‹†ç®±ã€‚
å…¶æ¬¡ï¼ŒKVCä¹Ÿæ”¯æŒæ•°ç»„å’Œå­—å…¸ç­‰é›†åˆæ•°æ®ã€‚è¿™é‡Œä¸å¤šæ¢è®¨ã€‚

## KVCçš„åŸç†ï¼šKVCæ˜¯æ€ä¹ˆè®¿é—®å±æ€§çš„ï¼Ÿ
>KVCåœ¨æŸç§ç¨‹åº¦ä¸Šæä¾›äº†æ›¿ä»£å­˜å–æ–¹æ³•ï¼ˆè®¿é—®å™¨æ–¹æ³•ï¼‰çš„æ–¹æ¡ˆï¼Œä¸è¿‡å­˜å–æ–¹æ³•ç»ˆç©¶æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œä»¥è‡³äºåªè¦æœ‰å¯èƒ½ï¼ŒKVCä¹Ÿå°½å¯èƒ½å…ˆå°è¯•ä½¿ç”¨å­˜å–æ–¹æ³•è®¿é—®å±æ€§ã€‚å½“ä½¿ç”¨KVCè®¿é—®å±æ€§æ—¶ï¼Œå®ƒå†…éƒ¨å…¶å®åšäº†å¾ˆå¤šäº‹ï¼š
>1.é¦–å…ˆæŸ¥æ‰¾æœ‰æ— `<property>`ï¼Œ`set<property>`ï¼Œ`is<property>`ç­‰propertyå±æ€§å¯¹åº”çš„å­˜å–æ–¹æ³•ï¼Œè‹¥æœ‰ï¼Œåˆ™ç›´æ¥ä½¿ç”¨è¿™äº›æ–¹æ³•;
>2.è‹¥æ— ï¼Œåˆ™ç»§ç»­æŸ¥æ‰¾`_<property>`ï¼Œ`_get<property>`ï¼Œ`set<property>`ç­‰æ–¹æ³•ï¼Œè‹¥æœ‰å°±ä½¿ç”¨ï¼›
>3.è‹¥æŸ¥è¯¢ä¸åˆ°ä»¥ä¸Šä»»ä½•å­˜å–æ–¹æ³•ï¼Œåˆ™å°è¯•ç›´æ¥è®¿é—®å®ä¾‹å˜é‡<property>ï¼Œ<property>ï¼›
>4.è‹¥è¿è¯¥æˆå‘˜å˜é‡ä¹Ÿè®¿é—®ä¸åˆ°ï¼Œåˆ™ä¼šåœ¨ä¸‹é¢æ–¹æ³•ä¸­æŠ›å‡ºå¼‚å¸¸ã€‚ä¹‹æ‰€ä»¥æä¾›è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œå°±æ˜¯è®©ä½ åœ¨å› è®¿é—®ä¸åˆ°è¯¥å±æ€§è€Œç¨‹åºå³å°†å´©æ‰å‰ï¼Œä¾›ä½ é‡å†™ï¼Œåœ¨å†…åšäº›å¤„ç†ï¼Œé˜²æ­¢ç¨‹åºç›´æ¥å´©æ‰ã€‚
`valueForUndefinedKey:`å’Œ`setValue:forUndefinedKey:`æ–¹æ³•ã€‚

## å…³äºKVO
### KVOæ˜¯ä»€ä¹ˆï¼Ÿ
Key-Value Obersverï¼Œå³é”®å€¼è§‚å¯Ÿã€‚å®ƒæ˜¯è§‚å¯Ÿè€…æ¨¡å¼çš„ä¸€ç§è¡ç”Ÿã€‚åŸºæœ¬æ€æƒ³æ˜¯ï¼Œå¯¹ç›®æ ‡å¯¹è±¡çš„æŸå±æ€§æ·»åŠ è§‚å¯Ÿï¼Œå½“è¯¥å±æ€§å‘ç”Ÿå˜åŒ–æ—¶ï¼Œä¼šè‡ªåŠ¨çš„é€šçŸ¥è§‚å¯Ÿè€…ã€‚è¿™é‡Œæ‰€è°“çš„é€šçŸ¥æ˜¯è§¦å‘è§‚å¯Ÿè€…å¯¹è±¡å®ç°çš„KVOçš„æ¥å£æ–¹æ³•ã€‚
** KVOæ˜¯è§£å†³modelå’ŒviewåŒæ­¥çš„å¥½æ³•å­ã€‚**
å¦å¤–ï¼ŒKVOçš„ä¼˜ç‚¹æ˜¯å½“è¢«è§‚å¯Ÿçš„å±æ€§å€¼æ”¹å˜æ—¶æ˜¯ä¼šè‡ªåŠ¨å‘é€é€šçŸ¥çš„ï¼Œè¿™æ¯”é€šçŸ¥ä¸­å¿ƒéœ€è¦posté€šçŸ¥æ¥è¯´ï¼Œç®€å•äº†è®¸å¤šã€‚

### KVOæ€ä¹ˆç”¨ï¼Ÿ
1.é¦–å…ˆç»™ç›®æ ‡å¯¹è±¡çš„å±æ€§æ·»åŠ è§‚å¯Ÿï¼š
```
- (void)addObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath options:(NSKeyValueObservingOptions)options context:(nullable void *)context;
```
2.å®ç°ä¸‹é¢æ–¹æ³•æ¥æ¥æ”¶é€šçŸ¥ï¼Œéœ€è¦æ³¨æ„å„ä¸ªå‚æ•°çš„å«ä¹‰ï¼š
```
- (void)observeValueForKeyPath:(nullable NSString *)keyPath ofObject:(nullable id)object change:(nullable NSDictionary<NSString*, id> *)change context:(nullable void *)context;
```
3.æœ€åè¦ç§»é™¤è§‚å¯Ÿè€…ï¼š
```
- (void)removeObserver:(NSObject *)observer forKeyPath:(NSString *)keyPath;
```
ä¸¾ä¸€ä¸ªğŸŒ°ï¼š
```
#import "ViewController.h"
#import "Student.h"


@interface ViewController ()
{
	Student             *_student;
}

@end

@implementation ViewController

- (void)viewDidLoad {
	[super viewDidLoad];

	_student = [[Student alloc] init];
	_student.stuName = @"oldName_hu";

	// 1.ç»™studentå¯¹è±¡çš„æ·»åŠ è§‚å¯Ÿè€…ï¼Œè§‚å¯Ÿå…¶stuNameå±æ€§
	[_student addObserver:self forKeyPath:@"stuName" 		options:NSKeyValueObservingOptionNew|NSKeyValueObservingOptionOld 	context:nil];

	// æ­¤æ—¶ï¼ŒstuNameå‘ç”Ÿäº†å˜åŒ–
	_student.stuName = @"newName_wang";
}

// stuNameå‘ç”Ÿå˜åŒ–åï¼Œè§‚å¯Ÿè€…ï¼ˆselfï¼‰ç«‹é©¬å¾—åˆ°é€šçŸ¥ã€‚
- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary<NSString *,id> *)change context:(void *)context
{
	// æœ€å¥½åˆ¤æ–­ç›®æ ‡å¯¹è±¡objectå’Œå±æ€§è·¯å¾„keyPath
	if(object == _student && [keyPath isEqualToString:@"stuName"])
{
	NSLog(@"----old:%@----new:%@",change[@"old"],change[@"new"]);
}else{
	[super observeValueForKeyPath:keyPath ofObject:object change:change context:context];
	}
}


- (void)dealloc
{
	// ç§»é™¤è§‚å¯Ÿè€…
	[_student removeObserver:self forKeyPath:@"stuName"];
}

@end
```
ä¸Šé¢ä»£ç éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯æ¥æ”¶é€šçŸ¥çš„æ–¹æ³•é‡Œæœ€å¥½åˆ¤æ–­ä¸€ä¸‹ç›®æ ‡å¯¹è±¡å’Œå±æ€§è·¯å¾„ï¼Œå› ä¸ºæœ‰å¯èƒ½æœ‰å¤šä¸ªKVOè§‚å¯Ÿå¤šä¸ªå¯¹è±¡çš„å±æ€§ï¼›è€Œä¸”ï¼Œçˆ¶ç±»ä¹Ÿæœ‰å¯èƒ½ä½¿ç”¨äº†KVOå“¦ï¼Œæ‰€ä»¥åœ¨elseé‡Œï¼Œå¯¹ç°æœ‰æ¡ä»¶å¤–çš„æƒ…å†µäº¤ç»™çˆ¶ç±»å»å¤„ç†ã€‚

### KVOçš„åŸç†ï¼šKVOæ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ
>å½“æŸä¸ªç±»çš„å¯¹è±¡ç¬¬ä¸€æ¬¡è¢«è§‚å¯Ÿæ—¶ï¼Œç³»ç»Ÿå°±ä¼šåœ¨è¿è¡ŒæœŸåŠ¨æ€åœ°åˆ›å»ºè¯¥ç±»çš„ä¸€ä¸ªæ´¾ç”Ÿç±»ï¼Œåœ¨è¿™ä¸ªæ´¾ç”Ÿç±»ä¸­é‡å†™åŸºç±»ä¸­è¢«è§‚å¯Ÿå±æ€§çš„ setter æ–¹æ³•ï¼Œåœ¨setteræ–¹æ³•é‡Œä½¿å…¶å…·æœ‰é€šçŸ¥æœºåˆ¶ã€‚å› æ­¤ï¼Œè¦æƒ³KVOç”Ÿæ•ˆï¼Œå¿…é¡»ç›´æ¥æˆ–é—´æ¥çš„é€šè¿‡setteræ–¹æ³•è®¿é—®å±æ€§ï¼ˆKVCçš„setValueå°±æ˜¯é—´æ¥æ–¹å¼ï¼‰ã€‚ç›´æ¥è®¿é—®æˆå‘˜å˜é‡KVOæ˜¯ä¸ç”Ÿæ•ˆçš„ã€‚

>åŒæ—¶æ´¾ç”Ÿç±»è¿˜é‡å†™äº† class æ–¹æ³•ä»¥â€œæ¬ºéª—â€å¤–éƒ¨è°ƒç”¨è€…å®ƒå°±æ˜¯èµ·åˆçš„é‚£ä¸ªç±»ã€‚ç„¶åç³»ç»Ÿå°†è¿™ä¸ªå¯¹è±¡çš„`isa` æŒ‡é’ˆæŒ‡å‘è¿™ä¸ªæ–°è¯ç”Ÿçš„æ´¾ç”Ÿç±»ï¼Œå› æ­¤è¿™ä¸ªå¯¹è±¡å°±æˆä¸ºè¯¥æ´¾ç”Ÿç±»çš„å¯¹è±¡äº†ï¼Œå› è€Œåœ¨è¯¥å¯¹è±¡ä¸Šå¯¹` setter` çš„è°ƒç”¨å°±ä¼šè°ƒç”¨é‡å†™çš„` setter`ï¼Œä»è€Œæ¿€æ´»é”®å€¼é€šçŸ¥æœºåˆ¶ã€‚æ­¤å¤–ï¼Œæ´¾ç”Ÿç±»è¿˜é‡å†™äº† `dealloc` æ–¹æ³•æ¥é‡Šæ”¾èµ„æºã€‚

é‡æ–°çš„setteræ–¹æ³•é‡Œåˆ°åº•å¹²äº†ä»€ä¹ˆï¼Œè€Œä½¿å…¶å°±æœ‰äº†é€šçŸ¥æœºåˆ¶å‘¢ï¼Ÿå…¶å®åªæ˜¯åœ¨setteræ–¹æ³•é‡Œï¼Œç»™å±æ€§èµ‹å€¼çš„å‰ååˆ†åˆ«è°ƒç”¨äº†ä¸¤ä¸ªæ–¹æ³•
```
- (void)willChangeValueForKey:(NSString *)key;
- (void)didChangeValueForKey:(NSString *)key;
```
è€Œ`- (void)didChangeValueForKey:(NSString *)key;`ä¼šè°ƒç”¨
```
- (void)observeValueForKeyPath:(nullable NSString *)keyPath ofObject:(nullable id)object change:(nullable NSDictionary<NSString*, id> *)change context:(nullable void *)context;
```
è¿™å°±æ˜¯KVOå®ç°çš„åŸºæœ¬åŸç†äº†ï¼
å½“æ²¡æœ‰å­˜å–æ–¹æ³•è€Œé€šè¿‡KVCçš„setValueä¿®æ”¹å±æ€§å€¼æ—¶ï¼ŒåŒæ ·çš„åœ¨è¿è¡Œæ—¶ä¹Ÿä¼šåœ¨`setValue:forKey`æ–¹æ³•é‡Œé»˜è®¤è°ƒç”¨ä¸Šé¢ä¿©æ–¹æ³•ã€‚
** å…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥æ‰‹åŠ¨ï¼Œæ˜¾å¼çš„è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œä»¥ä½¿å…¶å…·æœ‰é€šçŸ¥æœºåˆ¶ã€‚**
ä¸‹é¢ç”¨ä¾‹å­éªŒè¯ï¼š
```
#import "ViewController.h"

@interface ViewController ()
{
	NSString            *_testStr;
}

@end

@implementation ViewController

- (void)viewDidLoad {
	[super viewDidLoad];

	// ç»™selfçš„æ·»åŠ selfè§‚å¯Ÿè€…ï¼Œè‡ªå·±è§‚å¯Ÿè‡ªå·±çš„testStræˆå‘˜å˜é‡
	[self addObserver:self forKeyPath:@"testStr" 	options:NSKeyValueObservingOptionNew context:nil];

	[self willChangeValueForKey:@"testStr"];
	_testStr = @"this is a test"; // ç›´æ¥ä¿®æ”¹æˆå‘˜å˜é‡çš„å€¼ï¼Œä½†æ˜¯æ˜¾å¼çš„ã€æ‰‹åŠ¨çš„	è°ƒç”¨ä¸Šä¸‹ä¿©æ–¹æ³•ï¼Œä½¿å…¶å°±æœ‰é€šçŸ¥æœºåˆ¶
	[self didChangeValueForKey:@"testStr"];
}


- (void)observeValueForKeyPath:(NSString *)keyPath ofObject:(id)object change:(NSDictionary<NSString *,id> *)change context:(void *)context
{
	if(object == self && [keyPath isEqualToString:@"testStr"])
	{
		NSLog(@"----new:%@----",change[@"new"]);
	}else{
		[super observeValueForKeyPath:keyPath ofObject:object change:change context:context];
	}
}


- (void)dealloc
{
	// ç§»é™¤è§‚å¯Ÿè€…
	[self removeObserver:self forKeyPath:@"stuName"];
}

@end
```


